<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Combined Reviews</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        #mockTestFilter {
            margin: 20px 0;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <h1>{{ exam.title }} - Combined Reviews</h1>

    <form id="controlsForm" method="GET">
        <label for="sort_by">Sort by:</label>
        <select id="sort_by" name="sort_by" onchange="document.getElementById('controlsForm').submit()">
            <option value="overall" {% if sort_by == 'overall' %}selected{% endif %}>Overall Rating</option>
            <option value="characteristic_1" {% if sort_by == 'characteristic_1' %}selected{% endif %}>Clarity of Concepts</option>
            <option value="characteristic_2" {% if sort_by == 'characteristic_2' %}selected{% endif %}>Difficulty Appropriateness</option>
            <option value="characteristic_3" {% if sort_by == 'characteristic_3' %}selected{% endif %}>Relevance to Exam Pattern</option>
            <option value="characteristic_4" {% if sort_by == 'characteristic_4' %}selected{% endif %}>Quality of Questions</option>
            <option value="characteristic_5" {% if sort_by == 'characteristic_5' %}selected{% endif %}>Time Management</option>
            <option value="characteristic_6" {% if sort_by == 'characteristic_6' %}selected{% endif %}>Overall Preparation Value</option>
            <option value="characteristic_7" {% if sort_by == 'characteristic_7' %}selected{% endif %}>Likelihood of Recommending</option>
        </select>

        <label for="show_count">Show:</label>
        <select id="show_count" name="show_count" onchange="document.getElementById('controlsForm').submit()">
            <option value="5" {% if show_count == 5 %}selected{% endif %}>Top 5</option>
            <option value="7" {% if show_count == 7 %}selected{% endif %}>Top 7</option>
            <option value="10" {% if show_count == 10 %}selected{% endif %}>Top 10</option>
            <option value="all" {% if show_count == 'all' %}selected{% endif %}>Show All</option>
        </select>
    </form>

    <h2>Top Ranked Mock Tests</h2>
    {% if top_mock_tests %}
        <ul>
            {% for mock_test in top_mock_tests %}
                <li>{{ mock_test.title }} - Average Rating: {{ mock_test.avg_rating|default:"N/A" }}</li>
            {% endfor %}
        </ul>
    {% else %}
        <p>No top mock tests available.</p>
    {% endif %}

    <div id="mockTestFilter">
        <label for="mockTestSelect">Select Mock Tests to Compare:</label>
        <select id="mockTestSelect" multiple>
            {% for mock_test in mock_tests %}
                <option value="{{ mock_test.id }}">{{ mock_test.title }}</option>
            {% endfor %}
        </select>
        <button id="addButton" onclick="addSelected()">Add Selected</button>
    </div>

    <h3>Select Chart Type:</h3>
    <button onclick="switchChartType('radar')">Radar Chart</button>
    <button onclick="switchChartType('bar')">Bar Chart</button>
    <button onclick="switchChartType('line')">Line Chart</button>
    <button onclick="switchChartType('pie')">Pie Chart</button>

    <canvas id="chartCanvas" width="400" height="400"></canvas>

    <script>
        const radarData = {{ radar_data_json|safe }};
        let chartType = 'radar';  // Default chart type
        const ctx = document.getElementById('chartCanvas').getContext('2d');
        let selectedMockTests = []; // Store currently selected mock tests for comparison

        let chart = new Chart(ctx, {
            type: chartType,
            data: {
                labels: radarData.labels,
                datasets: []
            },
            options: {
                responsive: true,
                scales: {
                    r: { beginAtZero: true, max: 5 },
                    y: { beginAtZero: true, max: 5 }
                }
            }
        });

        function updateChart() {
            const filteredDatasets = radarData.datasets.filter(dataset => selectedMockTests.includes(dataset.label));
            chart.data.datasets = filteredDatasets;

            if (chartType === 'radar' && filteredDatasets.length > 2) {
                alert("Radar chart allows only 2 mock tests for comparison.");
                return;
            } else if ((chartType === 'bar' || chartType === 'line') && filteredDatasets.length > 4) {
                alert("Bar and Line charts allow only 4 mock tests for comparison.");
                return;
            } else if (chartType === 'pie' && filteredDatasets.length > 1) {
                alert("Pie chart allows only 1 mock test for comparison.");
                return;
            }

            chart.update();
        }

        function switchChartType(type) {
            chartType = type;
            chart.destroy();
            chart = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: radarData.labels,
                    datasets: []
                },
                options: {
                    responsive: true,
                    scales: chartType === 'radar' ? {
                        r: { beginAtZero: true, max: 5 }
                    } : {
                        y: { beginAtZero: true, max: 5 }
                    }
                }
            });
            updateChart();
        }

        function addSelected() {
            const selectedOptions = Array.from(document.getElementById('mockTestSelect').selectedOptions);
            
            if (selectedOptions.length === 0) {
                alert("Please select at least one mock test.");
                return;
            }

            selectedOptions.forEach(option => {
                if (!selectedMockTests.includes(option.value)) {
                    selectedMockTests.push(option.value);
                }
            });

            console.log("Selected Mock Tests:", selectedMockTests); // For debugging
            updateChart();
        }
    </script>
</body>
</html>

